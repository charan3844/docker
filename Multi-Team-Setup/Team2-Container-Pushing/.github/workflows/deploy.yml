name: TEAM 2 - Push to ACR & Deploy to Container App

on:
    workflow_dispatch:
        inputs:
            image-tag:
                description: "Image tag to push"
                required: true
                type: string
    workflow_run:
        workflows: ["TEAM 1 - Build Docker Image for MCP"]
        types: [completed]

env:
    ACR_LOGIN_SERVER: tlcaimcpacr.azurecr.io
    IMAGE_NAME: mcp
    ACA_NAME: tlc-ai-mcp-container-app-dev
    ACA_RG: rg-tlc-ai-dev-eus

jobs:
    push-and-deploy:
        runs-on: ubuntu-latest
        name: Push Image to ACR & Deploy
        if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

        permissions:
            contents: read
            id-token: write

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Determine Image Tag
              run: |
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                    TAG=${{ github.event.inputs.image-tag }}
                  else
                    TAG=${{ github.sha }}
                  fi
                  echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV

            - name: Azure Login
              uses: azure/login@v1
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: ACR Login
              uses: ./Shared-Composite-Actions/.github/actions/acr-login
              with:
                  acr-login-server: ${{ env.ACR_LOGIN_SERVER }}

            - name: Push Docker Image to ACR
              uses: ./Shared-Composite-Actions/.github/actions/push-docker-image
              with:
                  acr-login-server: ${{ env.ACR_LOGIN_SERVER }}
                  image-name: ${{ env.IMAGE_NAME }}
                  image-tag: ${{ env.IMAGE_TAG }}

            - name: Update Container App Image
              run: |
                  ACR_IMAGE_URL="${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

                  echo "Updating Container App: ${{ env.ACA_NAME }}"
                  echo "New Image URL: $ACR_IMAGE_URL"

                  az containerapp update \
                    --name ${{ env.ACA_NAME }} \
                    --resource-group ${{ env.ACA_RG }} \
                    --image $ACR_IMAGE_URL

            - name: Verify Deployment
              run: |
                  echo "Waiting for deployment to complete..."
                  sleep 10

                  az containerapp show \
                    --name ${{ env.ACA_NAME }} \
                    --resource-group ${{ env.ACA_RG }} \
                    --query "properties.template.containers[0].image" \
                    -o tsv

            - name: Create Deployment Summary
              run: |
                  echo "## âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **Image**: ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Container App**: ${{ env.ACA_NAME }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Resource Group**: ${{ env.ACA_RG }}" >> $GITHUB_STEP_SUMMARY
