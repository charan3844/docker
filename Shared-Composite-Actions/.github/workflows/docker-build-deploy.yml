name: Docker Build and Deploy to ACR

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_dispatch:
        inputs:
            cleanup-old-images:
                description: "Run cleanup of old images"
                required: false
                type: boolean
                default: false

# REQUIRED for Azure OIDC login
permissions:
    id-token: write
    contents: read

env:
    # Azure / ACR
    ACR_NAME: ${{ secrets.ACR_NAME }}
    ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
    AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    # Image details
    REPO: ${{ secrets.REPO }}
    DOCKERFILE_PATH: MCPAgent/Dockerfile
    BUILD_CONTEXT: MCPAgent

jobs:
    build-and-push:
        name: Build and Push Docker Image
        runs-on: ubuntu-latest
        environment: dev

        outputs:
            image-url: ${{ steps.push.outputs.acr-image-url }}
            image-tag: ${{ steps.set-tag.outputs.tag }}

        steps:
            # 1. Checkout
            - name: Checkout Repository
              uses: actions/checkout@v4

            # 2. Set Image Tag
            - name: Set Image Tag
              id: set-tag
              shell: bash
              run: |
                  if [[ "${{ github.event_name }}" == "pull_request" ]]; then
                    TAG="pr-${{ github.event.pull_request.number }}"
                  else
                    TAG="latest"
                  fi
                  echo "tag=$TAG" >> $GITHUB_OUTPUT
                  echo "Using tag: $TAG"

            # 3. Azure Login (OIDC Federated)
            - name: Azure Login
              uses: azure/login@v1
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            # 4. Login to ACR (Shared Composite Action)
            - name: Login to ACR
              uses: ./.github/actions/acr-login

            # 5. Prepare Backup Directory (non-PR only)
            - name: Prepare backup directory
              if: github.event_name != 'pull_request'
              run: mkdir -p acr-backup

            # 6. Backup Existing Tags (non-PR only)
            - name: Backup Current Tags
              if: github.event_name != 'pull_request'
              uses: ./.github/actions/backup-tag
              with:
                  acr-name: ${{ env.ACR_NAME }}
                  repo: ${{ env.REPO }}
                  backup-location: ./acr-backup

            # 7. Build Docker Image
            - name: Build Docker Image
              id: build
              uses: ./.github/actions/build-docker-image

            # 8. Push Image (non-PR only)
            - name: Push to ACR
              if: github.event_name != 'pull_request'
              id: push
              uses: ./.github/actions/push-docker-image

            # 9. Upload Backup Artifact (non-PR only)
            - name: Upload Backup
              if: github.event_name != 'pull_request'
              uses: actions/upload-artifact@v4
              with:
                  name: acr-backup-${{ github.run_id }}
                  path: ./acr-backup/
                  retention-days: 30

    cleanup:
        name: Cleanup Old Images
        runs-on: ubuntu-latest
        environment: dev
        needs: build-and-push
        if: |
            (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
            (github.event_name == 'workflow_dispatch' && github.event.inputs.cleanup-old-images == 'true')

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Azure Login
              uses: azure/login@v1
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Login to ACR
              uses: ./.github/actions/acr-login

            - name: Cleanup Old Images
              uses: ./.github/actions/cleanup-old-images
              with:
                  acr-login-server: ${{ env.ACR_LOGIN_SERVER }}
                  repo: ${{ env.REPO }}
                  keep-count: "10"
                  older-than-days: "30"

    notify:
        name: Send Notification
        runs-on: ubuntu-latest
        needs: [build-and-push, cleanup]
        if: always()

        steps:
            - name: Build Status
              run: |
                  echo "Build Result: ${{ needs.build-and-push.result }}"
                  echo "Image URL: ${{ env.ACR_LOGIN_SERVER }}/${{ env.REPO }}"
                  echo "Image Tag: ${{ needs.build-and-push.outputs.image-tag }}"

            - name: Cleanup Status
              if: needs.cleanup.result != 'skipped'
              run: |
                  echo "Cleanup Result: ${{ needs.cleanup.result }}"
